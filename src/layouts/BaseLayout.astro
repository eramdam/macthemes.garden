---
import OS9Window, { WindowButtons } from "../components/OS9Window.astro";
import { getCollectionStats } from "../content.config";
import { TZDate } from "@date-fns/tz";
import "../styles/index.css";

interface Props {
  title: string | undefined;
  description?: string;
  image?: string;
}

const { themes, authors } = await getCollectionStats();
const title = Astro.props.title
  ? `Mac Themes Garden | ${Astro.props.title}`
  : `Mac Themes Garden`;
const canonicalUrl = new URL(Astro.url.pathname, Astro.site);
const description =
  Astro.props.description ??
  `Mac Themes Garden is dedicated to showcasing schemes made for Kaleidoscope and celebrating the customization and expressiveness it enabled on Classic Mac OS.`;
const image = Astro.props.image
  ? Astro.props.image
  : "/assets/macthemes-garden-opengraph.webp";
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Mac Themes Garden Feed"
      href={new URL("feed.xml", Astro.site)}
    />
    <link rel="icon" href="/favicon.png" />
    <meta property="og:url" content={canonicalUrl} />
    <link rel="canonical" href={canonicalUrl} />

    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="twitter:description" content={description} />
    <meta name="og:description" content={description} />

    <meta property="og:type" content="website" />
    <meta property="twitter:domain" content={new URL("/", Astro.site).host} />

    <meta property="twitter:title" content={title} />
    <meta property="og:title" content={title} />

    <meta property="twitter:image" content={image} />
    <meta property="og:image" content={image} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="fediverse:creator" content="@macthemes@erambert.me" />

    <script
      defer
      is:inline
      data-domain="macthemes.garden"
      src="https://plausible.erambert.me/js/script.js"></script>
  </head>

  <body>
    <OS9Window
      asElement="header"
      title="Welcome!"
      classname="header-box"
      buttons={[WindowButtons.Close, WindowButtons.Collapse]}
    >
      <div class="header-image-box">
        <a href="/" class="header-image">
          <img src="/assets/macthemes-garden-header.png" alt="" />
        </a>
      </div>

      <nav>
        <ul class="macos9-menu">
          <li>
            <a href="/" class="macos9-menu-icon">
              <img src="/assets/menu/schemes-puzzle.png" alt="" />
              <span> Schemes </span>
            </a>
          </li>
          <li>
            <a href="/authors" class="macos9-menu-icon">
              <img src="/assets/menu/file-sharing.png" alt="" />
              <span> Authors </span>
            </a>
          </li>
          <span class="spacer"></span>
          <li>
            <a href="/feed" class="macos9-menu-icon">
              <img src="/assets/menu/feed.png" alt="" />
              <span> Feed </span>
            </a>
          </li>
          <li>
            <a href="/search" class="macos9-menu-icon">
              <img src="/assets/menu/search.png" alt="" />
              <span> Search </span>
            </a>
          </li>
          <li>
            <a href="/about" class="macos9-menu-icon">
              <img src="/assets/menu/finder-computer.png" alt="" />
              <span> About </span>
            </a>
          </li>
        </ul>
      </nav>
    </OS9Window>
    <slot />
    <OS9Window asElement="footer" title="Footer" classname="footer">
      <p>
        All the themes showcased are the property of their respective authors.
        Not affiliated with Apple Inc.
      </p>
      <p>
        As of {
          new TZDate(Date.now(), "America/Los_Angeles").toLocaleDateString(
            "en",
            {
              dateStyle: "medium",
            }
          )
        }, there are <a href="/">{themes.toLocaleString()} themes</a> from <a
          href="/authors">{authors.toLocaleString()} authors</a
        >
      </p>
    </OS9Window>
    <script>
      document.querySelectorAll(".macos9-window").forEach((windowElement) => {
        const id = windowElement.getAttribute("id");
        const storageKey = `macthemes-window-${id}`;
        const windowState = JSON.parse(
          localStorage.getItem(storageKey) ||
            `{"collapsed": false,"zoomed": false}`
        );
        if (windowState.collapsed) {
          windowElement.classList.add("collapsed");
        } else if (windowState.zoomed) {
          windowElement.classList.add("zoomed");
        }

        function setWindowState(state: any) {
          const currentState = JSON.parse(
            localStorage.getItem(storageKey) ||
              `{"collapsed": false,"zoomed": false}`
          );

          currentState.collapsed =
            state === "collapsed"
              ? !currentState.collapsed
              : currentState.collapsed;
          currentState.zoomed =
            state === "zoomed" ? !currentState.zoomed : currentState.zoomed;

          localStorage.setItem(storageKey, JSON.stringify(currentState));
        }

        windowElement.querySelectorAll("button").forEach((button) => {
          if (button.dataset.action === "collapse") {
            const titlebar = windowElement.querySelector(
              ".macos9-window-titlebar"
            );
            if (titlebar) {
              titlebar.addEventListener("dblclick", (e) => {
                if (e.target instanceof HTMLButtonElement) {
                  return;
                }

                windowElement.classList.toggle("collapsed");
                setWindowState("collapsed");
                window.getSelection()?.empty();
              });
            }
          }
          button.addEventListener("click", () => {
            const action = button.dataset.action;
            if (action === "collapse") {
              windowElement.classList.toggle("collapsed");
              setWindowState("collapsed");
            } else if (action === "zoom") {
              windowElement.classList.toggle("zoomed");
              setWindowState("zoomed");
            }
          });
        });
      });
    </script>
  </body>
</html>
