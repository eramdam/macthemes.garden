---
import { getCollection, getEntries } from "astro:content";
import OS9Window from "../../components/OS9Window.astro";
import { SingleTheme } from "../../components/singleTheme";
import {
  getLikeCountsByThemeIds,
  getLikesCountForThemeId,
} from "../../helpers/dbHelpers";
import BaseLayout from "../../layouts/BaseLayout.astro";

const authorSlug = Astro.params.author;
const authors = await getCollection("authors");
const author = authors.find((a) => a.data.slug === authorSlug);

if (!author) {
  return Astro.redirect("/404");
}

const themesByAuthor = await getEntries(author.data.themes);
const likesCountByThemeIds = await getLikeCountsByThemeIds(Astro.session);
---

<BaseLayout title={`Themes by ${author.data.name}`}>
  <OS9Window asElement="main" title={`Themes by ${author.data.name}`}>
    <div class="single-author-page">
      <h1 class="single-theme-title">
        Themes by {author.data.name}
      </h1>
      <div class="themes-grid">
        {
          themesByAuthor
            .map((t) => t.data)
            .map(async (theme, index) => {
              const authors = (await getEntries(theme.authors)).map(
                (a) => a.data
              );
              const themeId = themesByAuthor[index].id;
              const likesCount = likesCountByThemeIds[themeId];

              return (
                <SingleTheme
                  likes={likesCount}
                  theme={theme}
                  authors={authors}
                />
              );
            })
        }
      </div>
    </div>
  </OS9Window>
</BaseLayout>
